let geojsonData=null,visibleColumns={},filteredFeatures=[],selectedRowIndex=null;document.getElementById("fileInput").addEventListener("change",handleFile),document.getElementById("fontSizeSelect").addEventListener("change",e=>{document.documentElement.style.setProperty("--font-size",e.target.value)}),document.getElementById("toggleColumnsBtn").addEventListener("click",()=>{const e=document.getElementById("columnList");e.style.display="block"===e.style.display?"none":"block"}),document.getElementById("searchInput").addEventListener("input",handleSearch),document.getElementById("toggleMapBtn").addEventListener("click",toggleMap),document.getElementById("exportExcelBtn").addEventListener("click",()=>{if(!geojsonData)return alert("No data to export.");const e=filteredFeatures||geojsonData.features,t=Object.keys(e[0].properties).filter(e=>visibleColumns[e]),o=e.map(e=>{const o={};return t.forEach(t=>o[t]=e.properties[t]??""),o}),n=XLSX.utils.json_to_sheet(o),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,n,"Attributes"),XLSX.writeFile(a,"geojson_attributes.xlsx")});const MapPreview=(()=>{let e,t,o,n;function a(){if(e)return;e=L.map("map").setView([20,80],4);const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; OpenStreetMap contributors"}),o=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{attribution:"Tiles &copy; Google"}),n=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{attribution:"Tiles &copy; Google Hybrid"});t.addTo(e);const a={OpenStreetMap:t,"Google Street":o,"Google Hybrid":n};L.control.layers(a,null,{position:"topright"}).addTo(e)}function r(t){e&&(o&&o.remove(),o=L.geoJSON(t,{style:{color:"red",weight:3,fillOpacity:.3},pointToLayer:(e,t)=>L.circleMarker(t,{radius:6,color:"red",weight:3})}).addTo(e),setTimeout(()=>{try{e.fitBounds(o.getBounds(),{maxZoom:12})}catch(o){const n=t.geometry.coordinates;Array.isArray(n)&&n.length>=2&&e.setView([n[1],n[0]],10)}},150))}return{loadGeoJSON:function(o,i){e||a(),o&&(t&&t.remove(),n=i,t=L.geoJSON(o,{style:{color:"#0078d4",weight:2,fillOpacity:.2},pointToLayer:(e,t)=>L.circleMarker(t,{radius:5,color:"#0078d4"}),onEachFeature:(e,t)=>{t.on("click",()=>{r(e),"function"==typeof n&&n(e)})}}).addTo(e),setTimeout(()=>{try{const o=t.getBounds();o.isValid()&&e.fitBounds(o)}catch{e.setView([20,80],4)}},200))},highlightFeature:r,refresh:function(){e&&e.invalidateSize()},initMap:a}})();async function handleFile(e){const t=e.target.files[0];if(!t)return;const o=await t.text();geojsonData=JSON.parse(o);const n=geojsonData.features;if(!n?.length)return alert("No features found in GeoJSON.");const a=Object.keys(n[0].properties);visibleColumns=Object.fromEntries(a.map(e=>[e,!0])),filteredFeatures=n,renderColumnList(a),renderTable(),MapPreview.loadGeoJSON(geojsonData,handleMapFeatureClick),document.getElementById("saveBtn").style.display="inline-block",document.getElementById("exportExcelBtn").style.display="inline-block"}function renderColumnList(e){const t=document.getElementById("columnList");t.innerHTML="",e.forEach(e=>{const o=document.createElement("label");o.innerHTML=`<input type="checkbox" checked data-key="${e}"><span>${e}</span>`,t.appendChild(o)}),t.addEventListener("change",e=>{if(e.target.matches("input[type=checkbox]")){const t=e.target.dataset.key;visibleColumns[t]=e.target.checked,renderTable()}})}function handleSearch(e){const t=e.target.value.trim().toLowerCase();filteredFeatures=t?geojsonData.features.filter(e=>Object.entries(e.properties).some(([e,o])=>visibleColumns[e]&&String(o??"").toLowerCase().includes(t))):geojsonData.features,renderTable()}function renderTable(){const e=filteredFeatures,t=document.getElementById("tableContainer");if(!e.length)return void(t.innerHTML="<p style='padding:10px;'>No matching records.</p>");const o=Object.keys(e[0].properties).filter(e=>visibleColumns[e]);let n="<table><thead><tr>";o.forEach(e=>n+=`<th class="resizable">${e}<div class="resize-handle"></div></th>`),n+="</tr></thead><tbody>",e.forEach((e,t)=>{n+=`<tr data-row="${t}">`,o.forEach(o=>{n+=`<td contenteditable="true" data-row="${t}" data-key="${o}">${e.properties[o]??""}</td>`}),n+="</tr>"}),n+="</tbody></table>",t.innerHTML=n,"function"==typeof fltr_build&&fltr_build(),enableResizing(),enableRowSelection()}function enableRowSelection(){document.querySelectorAll("tbody tr").forEach(e=>{e.addEventListener("click",t=>{document.querySelectorAll("tbody tr").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),selectedRowIndex=+e.dataset.row;const o=filteredFeatures[selectedRowIndex];MapPreview.highlightFeature(o)})})}function enableResizing(){document.querySelectorAll("th.resizable").forEach(e=>{let t,o;e.querySelector(".resize-handle").addEventListener("mousedown",n=>{t=n.pageX,o=e.offsetWidth,document.body.style.cursor="col-resize";const a=n=>{const a=Math.max(40,o+(n.pageX-t));e.style.width=a+"px"},r=()=>{document.body.style.cursor="",window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",r)};window.addEventListener("mousemove",a),window.addEventListener("mouseup",r)})})}function toggleMap(){const e=document.getElementById("mapPanel").classList.toggle("expanded"),t=document.getElementById("tableWrapper");e?(t.style.maxHeight="32vh",t.style.height="",setTimeout(()=>{MapPreview.refresh(),geojsonData&&MapPreview.loadGeoJSON(geojsonData,handleMapFeatureClick)},300)):(t.style.maxHeight="520px",t.style.height="520px")}function handleMapFeatureClick(e){const t=filteredFeatures.indexOf(e);if(-1===t)return;const o=document.getElementById("tableWrapper").querySelectorAll("tbody tr");o.forEach(e=>e.classList.remove("selected"));const n=o[t];n&&(n.classList.add("selected"),n.scrollIntoView({behavior:"smooth",block:"center"}))}document.addEventListener("input",e=>{if(e.target.matches('td[contenteditable="true"]')){const t=+e.target.dataset.row,o=e.target.dataset.key,n=filteredFeatures[t];n&&(n.properties[o]=e.target.innerText.trim())}}),document.getElementById("saveBtn").addEventListener("click",async()=>{const e=JSON.stringify(geojsonData,null,2);if("showSaveFilePicker"in window)try{const t=await window.showSaveFilePicker({suggestedName:"edited.geojson",types:[{description:"GeoJSON",accept:{"application/geo+json":[".geojson"],"application/json":[".json"]}}]}),o=await t.createWritable();return await o.write(e),await o.close(),void alert("File saved!")}catch(e){console.warn(e)}const t=new Blob([e],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(t),o.download="edited.geojson",o.click(),URL.revokeObjectURL(o.href)}),document.addEventListener("DOMContentLoaded",()=>{MapPreview.initMap(),MapPreview.refresh()});